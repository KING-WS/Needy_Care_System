<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.sm.app.repository.ScheduleRepository">

    <resultMap id="scheduleResultMap" type="edu.sm.app.dto.Schedule">
        <id property="schedId" column="sched_id" />
        <result property="recId" column="rec_id" />
        <result property="schedDate" column="sched_date" />
        <result property="schedName" column="sched_name" />
        <result property="schedStartTime" column="sched_start_time" />
        <result property="schedEndTime" column="sched_end_time" />
        <result property="isDeleted" column="is_deleted" />
        <result property="schedRegdate" column="sched_regdate" />
        <result property="schedUpdate" column="sched_update" />
    </resultMap>

    <!-- Schedule CRUD -->
    <select id="selectSchedulesByRecId" resultMap="scheduleResultMap">
        SELECT 
            sched_id,
            rec_id,
            sched_date,
            sched_name,
            sched_start_time,
            sched_end_time,
            is_deleted,
            sched_regdate,
            sched_update
        FROM Schedule
        WHERE rec_id = #{recId} AND is_deleted = 'N'
        ORDER BY sched_date DESC
    </select>

    <select id="selectSchedulesByRecIdAndMonth" resultMap="scheduleResultMap">
        SELECT 
            sched_id,
            rec_id,
            sched_date,
            sched_name,
            sched_start_time,
            sched_end_time,
            is_deleted,
            sched_regdate,
            sched_update
        FROM Schedule
        WHERE rec_id = #{recId}
            AND YEAR(sched_date) = #{year}
            AND MONTH(sched_date) = #{month}
            AND is_deleted = 'N'
        ORDER BY sched_date
    </select>

    <select id="selectSchedulesByDateRange" resultMap="scheduleResultMap">
        SELECT
            sched_id,
            rec_id,
            sched_date,
            sched_name,
            sched_start_time,
            sched_end_time,
            is_deleted,
            sched_regdate,
            sched_update
        FROM Schedule
        WHERE rec_id = #{recId}
          AND sched_date BETWEEN #{startDate} AND #{endDate}
          AND is_deleted = 'N'
        ORDER BY sched_date
    </select>

    <select id="selectScheduleById" resultMap="scheduleResultMap">
        SELECT 
            sched_id,
            rec_id,
            sched_date,
            sched_name,
            sched_start_time,
            sched_end_time,
            is_deleted,
            sched_regdate,
            sched_update
        FROM Schedule
        WHERE sched_id = #{schedId} AND is_deleted = 'N'
    </select>

    <insert id="insertSchedule" useGeneratedKeys="true" keyProperty="schedId">
        INSERT INTO Schedule (rec_id, sched_date, sched_name, sched_start_time, sched_end_time, is_deleted, sched_regdate, sched_update)
        VALUES (#{recId}, #{schedDate}, #{schedName}, #{schedStartTime}, #{schedEndTime}, 'N', NOW(), NOW())
    </insert>

    <update id="updateSchedule" parameterType="edu.sm.app.dto.Schedule">
        UPDATE Schedule
        SET sched_name = #{schedName},
            sched_start_time = #{schedStartTime},
            sched_end_time = #{schedEndTime},
            sched_update = CURRENT_TIMESTAMP
        WHERE sched_id = #{schedId}
    </update>

    <update id="deleteSchedule" parameterType="int">
        UPDATE Schedule
        SET is_deleted = 'Y',
            sched_update = CURRENT_TIMESTAMP
        WHERE sched_id = #{schedId}
    </update>

</mapper>