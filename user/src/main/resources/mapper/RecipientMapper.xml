<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.sm.app.repository.RecipientRepository">

    <!-- custId로 돌봄 대상자 목록 조회 (삭제되지 않은 것만) -->
    <select id="selectRecipientsByCustId" resultType="edu.sm.app.dto.Recipient">
        SELECT
            rec_id AS recId,
            rec_type_code AS recTypeCode,
            cust_id AS custId,
            rec_name AS recName,
            rec_birthday AS recBirthday,
            rec_gender AS recGender,
            rec_kiosk_code AS recKioskCode,
            rec_address AS recAddress,
            rec_photo_url AS recPhotoUrl,
            rec_med_history AS recMedHistory,
            rec_allergies AS recAllergies,
            rec_spec_notes AS recSpecNotes,
            is_deleted AS isDeleted,
            rec_regdate AS recRegdate,
            rec_update AS recUpdate,
            rec_health_needs AS recHealthNeeds
        FROM Care_Recipient
        WHERE cust_id = #{custId}
          AND is_deleted = 'N'
        ORDER BY rec_regdate DESC
    </select>

    <!-- recId로 특정 돌봄 대상자 조회 -->
    <select id="selectRecipientById" resultType="edu.sm.app.dto.Recipient">
        SELECT
            rec_id AS recId,
            rec_type_code AS recTypeCode,
            cust_id AS custId,
            rec_name AS recName,
            rec_birthday AS recBirthday,
            rec_gender AS recGender,
            rec_kiosk_code AS recKioskCode,
            rec_address AS recAddress,
            rec_photo_url AS recPhotoUrl,
            rec_med_history AS recMedHistory,
            rec_allergies AS recAllergies,
            rec_spec_notes AS recSpecNotes,
            is_deleted AS isDeleted,
            rec_regdate AS recRegdate,
            rec_update AS recUpdate,
            rec_health_needs AS recHealthNeeds
        FROM Care_Recipient
        WHERE rec_id = #{recId}
          AND is_deleted = 'N'
    </select>

    <!-- 태블릿 코드로 돌봄 대상자 조회 -->
    <select id="selectRecipientByKioskCode" resultType="edu.sm.app.dto.Recipient">
        SELECT
            rec_id AS recId,
            rec_type_code AS recTypeCode,
            cust_id AS custId,
            rec_name AS recName,
            rec_birthday AS recBirthday,
            rec_gender AS recGender,
            rec_kiosk_code AS recKioskCode,
            rec_address AS recAddress,
            rec_photo_url AS recPhotoUrl,
            rec_med_history AS recMedHistory,
            rec_allergies AS recAllergies,
            rec_spec_notes AS recSpecNotes,
            is_deleted AS isDeleted,
            rec_regdate AS recRegdate,
            rec_update AS recUpdate,
            rec_health_needs AS recHealthNeeds
        FROM Care_Recipient
        WHERE rec_kiosk_code = #{kioskCode}
          AND is_deleted = 'N'
    </select>

    <!-- 돌봄 대상자 등록 -->
    <insert id="insertRecipient" parameterType="edu.sm.app.dto.Recipient" useGeneratedKeys="true" keyProperty="recId">
        INSERT INTO Care_Recipient (
            rec_type_code, cust_id, rec_name, rec_birthday, rec_gender,
            rec_kiosk_code, rec_address, rec_photo_url, rec_med_history,
            rec_allergies, rec_spec_notes, is_deleted, rec_regdate, rec_update, rec_health_needs
        )
        VALUES (
            #{recTypeCode}, #{custId}, #{recName}, #{recBirthday}, #{recGender},
            #{recKioskCode}, #{recAddress}, #{recPhotoUrl}, #{recMedHistory},
            #{recAllergies}, #{recSpecNotes}, 'N', NOW(), NOW(), #{recHealthNeeds}
        )
    </insert>

    <!-- 돌봄 대상자 수정 -->
    <update id="updateRecipient" parameterType="edu.sm.app.dto.Recipient">
        UPDATE Care_Recipient
        <set>
            <if test="recTypeCode != null and recTypeCode != ''">
                rec_type_code = #{recTypeCode},
            </if>
            <if test="recName != null and recName != ''">
                rec_name = #{recName},
            </if>
            <if test="recBirthday != null">
                rec_birthday = #{recBirthday},
            </if>
            <if test="recGender != null and recGender != ''">
                rec_gender = #{recGender},
            </if>
            <if test="recKioskCode != null">
                rec_kiosk_code = #{recKioskCode},
            </if>
            <if test="recAddress != null and recAddress != ''">
                rec_address = #{recAddress},
            </if>
            <if test="recPhotoUrl != null">
                rec_photo_url = #{recPhotoUrl},
            </if>
            <if test="recMedHistory != null">
                rec_med_history = #{recMedHistory},
            </if>
            <if test="recAllergies != null">
                rec_allergies = #{recAllergies},
            </if>
            <if test="recSpecNotes != null">
                rec_spec_notes = #{recSpecNotes},
            </if>
            <if test="recHealthNeeds != null">
                rec_health_needs = #{recHealthNeeds},
            </if>
            rec_update = NOW()
        </set>
        WHERE rec_id = #{recId}
    </update>

    <!-- 돌봄 대상자 삭제 (논리 삭제) -->
    <delete id="deleteRecipient" parameterType="Integer">
        UPDATE Care_Recipient
        SET is_deleted = 'Y', rec_update = NOW()
        WHERE rec_id = #{recId}
    </delete>

    <!-- 마지막 접속 시간 업데이트 -->
    <update id="updateLastConnectedAt">
        UPDATE Care_Recipient
        SET
            last_connected_at = #{lastConnectedAt},
            rec_update = NOW()
        WHERE rec_id = #{recId}
    </update>

    <!-- 위치 정보 업데이트 -->
    <update id="updateLocation">
        UPDATE Care_Recipient
        SET rec_latitude = #{recLatitude}, rec_longitude = #{recLongitude}, rec_update = NOW()
        WHERE rec_id = #{recId}
    </update>

</mapper>