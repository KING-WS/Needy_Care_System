<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.sm.app.repository.ActivityLogRepository">

    <select id="getRecentActivities" resultType="edu.sm.app.dto.ActivityLogDTO">
        SELECT * FROM (
            SELECT
                'USER_REG' as type,
                CONCAT('사용자 ''', IFNULL(cust_name, '이름없음'), ''' 님이 등록되었습니다.') as message,
                cust_regdate as timestamp,
                'bi-person-plus-fill' as iconClass,
                'bg-primary' as bgClass,
                IFNULL(CONCAT('/customer/detail?id=', cust_id), '#') as link
            FROM cust

            UNION ALL

            SELECT
                'SENIOR_REG' as type,
                CONCAT('어르신 ''', IFNULL(rec_name, '이름없음'), ''' 님이 등록되었습니다.') as message,
                rec_regdate as timestamp,
                'bi-person-wheelchair' as iconClass,
                'bg-info' as bgClass,
                IFNULL(CONCAT('/senior/detail/', rec_id), '#') as link
            FROM Care_Recipient

            UNION ALL

            SELECT
                'CAREGIVER_REG' as type,
                CONCAT('요양보호사 ''', IFNULL(caregiver_name, '이름없음'), ''' 님이 등록되었습니다.') as message,
                caregiver_regdate as timestamp,
                'bi-heart-fill' as iconClass,
                'bg-success' as bgClass,
                IFNULL(CONCAT('/caregiver/detail/', caregiver_id), '#') as link
            FROM caregiver

            UNION ALL

            SELECT
                'ALERT' as type,
                CONCAT('긴급: ', IFNULL(cr.rec_name, '이름없음'), '님 - ', al.alert_msg) as message,
                al.alert_regdate as timestamp,
                'bi-exclamation-triangle-fill' as iconClass,
                'bg-danger' as bgClass,
                '/admin/alerts' as link
            FROM Alert_Log al
            JOIN Care_Recipient cr ON al.rec_id = cr.rec_id
            WHERE al.alert_type = 'EMERGENCY'
        ) as recent_activities
        ORDER BY timestamp DESC
        LIMIT 5
    </select>

</mapper>
