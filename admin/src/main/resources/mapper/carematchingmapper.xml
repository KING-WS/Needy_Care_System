<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.sm.app.repository.CareMatchingRepository">

    <!-- 현재 매칭된 요양사-수급자 목록 조회 -->
    <select id="selectMatchedPairs" resultType="edu.sm.app.dto.CareMatching">
        SELECT
            cm.matching_id AS matchingId,
            cm.caregiver_id AS caregiverId,
            cm.rec_id AS recId,
            cg.caregiver_name AS caregiverName,
            cr.rec_name AS recName
        FROM care_matching cm
        LEFT JOIN caregiver cg ON cm.caregiver_id = cg.caregiver_id AND cg.is_deleted = 'N'
        LEFT JOIN Care_Recipient cr ON cm.rec_id = cr.rec_id AND cr.is_deleted = 'N'
        WHERE cm.is_deleted = 'N'
    </select>

    <!-- 매칭되지 않은 수급자 목록 조회 -->
    <select id="selectUnassignedSeniors" resultType="edu.sm.app.dto.Senior">
        SELECT *
        FROM Care_Recipient
        WHERE is_deleted = 'N'
        AND rec_id NOT IN (
            SELECT rec_id FROM care_matching WHERE is_deleted = 'N'
        )
    </select>

    <!-- 매칭되지 않은 요양사 목록 조회 -->
    <select id="selectUnassignedCaregivers" resultType="edu.sm.app.dto.Caregiver">
        SELECT *
        FROM caregiver
        WHERE is_deleted = 'N'
        AND caregiver_id NOT IN (
            SELECT caregiver_id FROM care_matching WHERE is_deleted = 'N'
        )
    </select>

    <!-- 신규 매칭 생성 -->
    <insert id="insertMatch" parameterType="edu.sm.app.dto.CareMatching">
        INSERT INTO care_matching (caregiver_id, rec_id, is_deleted)
        VALUES (#{caregiverId}, #{recId}, 'N')
    </insert>

    <!-- 매칭 비활성화 (소프트 삭제) -->
    <update id="deleteMatch">
        UPDATE care_matching
        SET is_deleted = 'Y'
        WHERE matching_id = #{matchingId}
    </update>

</mapper>
